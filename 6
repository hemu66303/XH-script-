local Start = tick() -- 启动计时
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local PlayerGui = Players.LocalPlayer:WaitForChild("PlayerGui")

-- 手动创建UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "XHScriptUI"
ScreenGui.Parent = PlayerGui

-- 主窗口（支持拖动）
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainWindow"
MainFrame.Size = UDim2.new(0, 500, 0, 400)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.new(0.3, 0.3, 0.3)
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

-- 窗口标题（拖动区域）
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "Title"
TitleLabel.Size = UDim2.new(1, -70, 0, 30) -- 留出关闭和最小化按钮位置
TitleLabel.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
TitleLabel.Text = "XH脚本"
TitleLabel.TextColor3 = Color3.new(1, 1, 1)
TitleLabel.TextSize = 18
TitleLabel.Parent = MainFrame

-- 最小化按钮
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Name = "MinimizeBtn"
MinimizeBtn.Size = UDim2.new(0, 30, 0, 30)
MinimizeBtn.Position = UDim2.new(1, -60, 0, 0)
MinimizeBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
MinimizeBtn.Text = "_"
MinimizeBtn.TextColor3 = Color3.new(1, 1, 1)
MinimizeBtn.TextSize = 16
MinimizeBtn.Parent = MainFrame

-- 关闭按钮
local CloseBtn = Instance.new("TextButton")
CloseBtn.Name = "CloseBtn"
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -30, 0, 0)
CloseBtn.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
CloseBtn.TextSize = 16
CloseBtn.Parent = MainFrame

-- 标签页切换栏
local TabFrame = Instance.new("Frame")
TabFrame.Name = "TabBar"
TabFrame.Size = UDim2.new(1, 0, 0, 30)
TabFrame.Position = UDim2.new(0, 0, 0, 30)
TabFrame.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
TabFrame.Parent = MainFrame

-- 公告标签按钮
local Tab1Btn = Instance.new("TextButton")
Tab1Btn.Name = "Tab1"
Tab1Btn.Size = UDim2.new(0, 100, 1, 0)
Tab1Btn.Text = "公告"
Tab1Btn.TextColor3 = Color3.new(1, 1, 1)
Tab1Btn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
Tab1Btn.Parent = TabFrame

-- 吃吃世界标签按钮
local Tab2Btn = Instance.new("TextButton")
Tab2Btn.Name = "Tab2"
Tab2Btn.Size = UDim2.new(0, 100, 1, 0)
Tab2Btn.Position = UDim2.new(0, 100, 0, 0)
Tab2Btn.Text = "吃吃世界"
Tab2Btn.TextColor3 = Color3.new(1, 1, 1)
Tab2Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
Tab2Btn.Parent = TabFrame

-- 透视标签按钮
local Tab3Btn = Instance.new("TextButton")
Tab3Btn.Name = "Tab3"
Tab3Btn.Size = UDim2.new(0, 100, 1, 0)
Tab3Btn.Position = UDim2.new(0, 200, 0, 0)
Tab3Btn.Text = "透视"
Tab3Btn.TextColor3 = Color3.new(1, 1, 1)
Tab3Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
Tab3Btn.Parent = TabFrame

-- 内容区域
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "Content"
ContentFrame.Size = UDim2.new(1, 0, 1, -60)
ContentFrame.Position = UDim2.new(0, 0, 0, 60)
ContentFrame.BackgroundTransparency = 1
ContentFrame.ClipsDescendants = true
ContentFrame.Parent = MainFrame

-- 公告内容
local NoticeLabel = Instance.new("TextLabel")
NoticeLabel.Name = "Notice"
NoticeLabel.Size = UDim2.new(1, -20, 1, -20)
NoticeLabel.Position = UDim2.new(0, 10, 0, 10)
NoticeLabel.BackgroundTransparency = 1
NoticeLabel.Text = "开发时间:2025年11月8日\n\n本脚本专为研发吃吃世界脚本为生。为了维护网络秩序和广大玩家的游戏体验，请大家合理使用脚本。若您在使用脚本的过程中遇到了一些BUG或问题，可以及时向我们脚本工作室反馈。为了保证脚本的安全性，未经脚本作者同意不得擅自宣传或倒卖。"
NoticeLabel.TextColor3 = Color3.new(1, 1, 1)
NoticeLabel.TextSize = 14
NoticeLabel.TextWrapped = true
NoticeLabel.Parent = ContentFrame

-- 吃吃世界内容（初始隐藏）- 改为可滚动框架
local EatWorldScrollFrame = Instance.new("ScrollingFrame")
EatWorldScrollFrame.Name = "EatWorldScrollFrame"
EatWorldScrollFrame.Size = UDim2.new(1, -20, 1, -20)
EatWorldScrollFrame.Position = UDim2.new(0, 10, 0, 10)
EatWorldScrollFrame.BackgroundTransparency = 1
EatWorldScrollFrame.Visible = false
EatWorldScrollFrame.ScrollBarThickness = 8
EatWorldScrollFrame.ScrollBarImageColor3 = Color3.new(0.5, 0.5, 0.5)
EatWorldScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 600) -- 增加高度以容纳血量回复功能
EatWorldScrollFrame.Parent = ContentFrame

-- 吃吃世界内容容器
local EatWorldFrame = Instance.new("Frame")
EatWorldFrame.Name = "EatWorldContent"
EatWorldFrame.Size = UDim2.new(1, 0, 0, 600) -- 增加高度以容纳血量回复功能
EatWorldFrame.BackgroundTransparency = 1
EatWorldFrame.Parent = EatWorldScrollFrame

-- 飞行功能按钮
local FlyBtn = Instance.new("TextButton")
FlyBtn.Name = "FlyBtn"
FlyBtn.Size = UDim2.new(0, 200, 0, 40)
FlyBtn.Position = UDim2.new(0.5, -100, 0, 20)
FlyBtn.BackgroundColor3 = Color3.new(0.3, 0.5, 0.8)
FlyBtn.Text = "飞行功能"
FlyBtn.TextColor3 = Color3.new(1, 1, 1)
FlyBtn.TextSize = 16
FlyBtn.Parent = EatWorldFrame

-- 飞行状态显示
local FlyStatus = Instance.new("TextLabel")
FlyStatus.Name = "FlyStatus"
FlyStatus.Size = UDim2.new(1, 0, 0, 30)
FlyStatus.Position = UDim2.new(0, 0, 0, 70)
FlyStatus.BackgroundTransparency = 1
FlyStatus.Text = "飞行功能未激活"
FlyStatus.TextColor3 = Color3.new(1, 1, 1)
FlyStatus.TextSize = 14
FlyStatus.Parent = EatWorldFrame

-- 无敌模式按钮
local GodModeBtn = Instance.new("TextButton")
GodModeBtn.Name = "GodModeBtn"
GodModeBtn.Size = UDim2.new(0, 200, 0, 40)
GodModeBtn.Position = UDim2.new(0.5, -100, 0, 110)
GodModeBtn.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)
GodModeBtn.Text = "无敌模式: 关闭"
GodModeBtn.TextColor3 = Color3.new(1, 1, 1)
GodModeBtn.TextSize = 16
GodModeBtn.Parent = EatWorldFrame

-- 无敌模式状态显示
local GodModeStatus = Instance.new("TextLabel")
GodModeStatus.Name = "GodModeStatus"
GodModeStatus.Size = UDim2.new(1, 0, 0, 30)
GodModeStatus.Position = UDim2.new(0, 0, 0, 160)
GodModeStatus.BackgroundTransparency = 1
GodModeStatus.Text = "无敌模式未激活"
GodModeStatus.TextColor3 = Color3.new(1, 1, 1)
GodModeStatus.TextSize = 14
GodModeStatus.Parent = EatWorldFrame

-- ========== 新增血量回复功能 ==========
-- 血量回复按钮
local HealthRegenBtn = Instance.new("TextButton")
HealthRegenBtn.Name = "HealthRegenBtn"
HealthRegenBtn.Size = UDim2.new(0, 200, 0, 40)
HealthRegenBtn.Position = UDim2.new(0.5, -100, 0, 200)
HealthRegenBtn.BackgroundColor3 = Color3.new(0.8, 0.3, 0.3)
HealthRegenBtn.Text = "血量回复: 关闭"
HealthRegenBtn.TextColor3 = Color3.new(1, 1, 1)
HealthRegenBtn.TextSize = 16
HealthRegenBtn.Parent = EatWorldFrame

-- 血量回复状态显示
local HealthRegenStatus = Instance.new("TextLabel")
HealthRegenStatus.Name = "HealthRegenStatus"
HealthRegenStatus.Size = UDim2.new(1, 0, 0, 30)
HealthRegenStatus.Position = UDim2.new(0, 0, 0, 250)
HealthRegenStatus.BackgroundTransparency = 1
HealthRegenStatus.Text = "血量回复未激活"
HealthRegenStatus.TextColor3 = Color3.new(1, 1, 1)
HealthRegenStatus.TextSize = 14
HealthRegenStatus.Parent = EatWorldFrame

-- 回复速度设置
local RegenSpeedLabel = Instance.new("TextLabel")
RegenSpeedLabel.Name = "RegenSpeedLabel"
RegenSpeedLabel.Size = UDim2.new(0.8, 0, 0, 25)
RegenSpeedLabel.Position = UDim2.new(0.1, 0, 0, 290)
RegenSpeedLabel.BackgroundTransparency = 1
RegenSpeedLabel.Text = "回复速度 (每秒血量):"
RegenSpeedLabel.TextColor3 = Color3.new(1, 1, 1)
RegenSpeedLabel.TextSize = 14
RegenSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
RegenSpeedLabel.Parent = EatWorldFrame

local RegenSpeedTextBox = Instance.new("TextBox")
RegenSpeedTextBox.Name = "RegenSpeedTextBox"
RegenSpeedTextBox.Size = UDim2.new(0.2, 0, 0, 25)
RegenSpeedTextBox.Position = UDim2.new(0.8, -10, 0, 290)
RegenSpeedTextBox.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
RegenSpeedTextBox.BorderColor3 = Color3.new(0.4, 0.4, 0.4)
RegenSpeedTextBox.Text = "5"
RegenSpeedTextBox.TextColor3 = Color3.new(1, 1, 1)
RegenSpeedTextBox.TextSize = 14
RegenSpeedTextBox.PlaceholderText = "输入回复速度"
RegenSpeedTextBox.Parent = EatWorldFrame

-- ========== 原有速度设置 ==========
-- 速度设置
local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Name = "SpeedLabel"
SpeedLabel.Size = UDim2.new(0.8, 0, 0, 25)
SpeedLabel.Position = UDim2.new(0.1, 0, 0, 325)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "移动速度 (默认16):"
SpeedLabel.TextColor3 = Color3.new(1, 1, 1)
SpeedLabel.TextSize = 14
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.Parent = EatWorldFrame

local SpeedTextBox = Instance.new("TextBox")
SpeedTextBox.Name = "SpeedTextBox"
SpeedTextBox.Size = UDim2.new(0.2, 0, 0, 25)
SpeedTextBox.Position = UDim2.new(0.8, -10, 0, 325)
SpeedTextBox.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
SpeedTextBox.BorderColor3 = Color3.new(0.4, 0.4, 0.4)
SpeedTextBox.Text = "16"
SpeedTextBox.TextColor3 = Color3.new(1, 1, 1)
SpeedTextBox.TextSize = 14
SpeedTextBox.PlaceholderText = "输入速度"
SpeedTextBox.Parent = EatWorldFrame

-- 跳跃高度设置
local JumpLabel = Instance.new("TextLabel")
JumpLabel.Name = "JumpLabel"
JumpLabel.Size = UDim2.new(0.8, 0, 0, 25)
JumpLabel.Position = UDim2.new(0.1, 0, 0, 360)
JumpLabel.BackgroundTransparency = 1
JumpLabel.Text = "跳跃高度 (默认50):"
JumpLabel.TextColor3 = Color3.new(1, 1, 1)
JumpLabel.TextSize = 14
JumpLabel.TextXAlignment = Enum.TextXAlignment.Left
JumpLabel.Parent = EatWorldFrame

local JumpTextBox = Instance.new("TextBox")
JumpTextBox.Name = "JumpTextBox"
JumpTextBox.Size = UDim2.new(0.2, 0, 0, 25)
JumpTextBox.Position = UDim2.new(0.8, -10, 0, 360)
JumpTextBox.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
JumpTextBox.BorderColor3 = Color3.new(0.4, 0.4, 0.4)
JumpTextBox.Text = "50"
JumpTextBox.TextColor3 = Color3.new(1, 1, 1)
JumpTextBox.TextSize = 14
JumpTextBox.PlaceholderText = "输入跳跃高度"
JumpTextBox.Parent = EatWorldFrame

-- 启用按钮
local ApplyBtn = Instance.new("TextButton")
ApplyBtn.Name = "ApplyBtn"
ApplyBtn.Size = UDim2.new(0, 150, 0, 35)
ApplyBtn.Position = UDim2.new(0.5, -75, 0, 395)
ApplyBtn.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
ApplyBtn.Text = "启用设置"
ApplyBtn.TextColor3 = Color3.new(1, 1, 1)
ApplyBtn.TextSize = 16
ApplyBtn.Parent = EatWorldFrame

-- 状态显示
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(1, 0, 0, 30)
StatusLabel.Position = UDim2.new(0, 0, 0, 440)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "等待设置..."
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.TextSize = 14
StatusLabel.Parent = EatWorldFrame

-- 透视内容（初始隐藏）
local ESPScrollFrame = Instance.new("ScrollingFrame")
ESPScrollFrame.Name = "ESPScrollFrame"
ESPScrollFrame.Size = UDim2.new(1, -20, 1, -20)
ESPScrollFrame.Position = UDim2.new(0, 10, 0, 10)
ESPScrollFrame.BackgroundTransparency = 1
ESPScrollFrame.Visible = false
ESPScrollFrame.ScrollBarThickness = 8
ESPScrollFrame.ScrollBarImageColor3 = Color3.new(0.5, 0.5, 0.5)
ESPScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 400)
ESPScrollFrame.Parent = ContentFrame

-- 透视内容容器
local ESPFrame = Instance.new("Frame")
ESPFrame.Name = "ESPContent"
ESPFrame.Size = UDim2.new(1, 0, 0, 400)
ESPFrame.BackgroundTransparency = 1
ESPFrame.Parent = ESPScrollFrame

-- 透视功能标题
local ESPTitle = Instance.new("TextLabel")
ESPTitle.Name = "ESPTitle"
ESPTitle.Size = UDim2.new(1, 0, 0, 40)
ESPTitle.Position = UDim2.new(0, 0, 0, 10)
ESPTitle.BackgroundTransparency = 1
ESPTitle.Text = "透视功能设置"
ESPTitle.TextColor3 = Color3.new(1, 1, 1)
ESPTitle.TextSize = 18
ESPTitle.TextWrapped = true
ESPTitle.Parent = ESPFrame

-- 射线功能开关
local RayToggle = Instance.new("TextButton")
RayToggle.Name = "RayToggle"
RayToggle.Size = UDim2.new(0.8, 0, 0, 35)
RayToggle.Position = UDim2.new(0.1, 0, 0, 60)
RayToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
RayToggle.Text = "射线功能: 关闭"
RayToggle.TextColor3 = Color3.new(1, 1, 1)
RayToggle.TextSize = 14
RayToggle.Parent = ESPFrame

-- 显示名字开关
local NameToggle = Instance.new("TextButton")
NameToggle.Name = "NameToggle"
NameToggle.Size = UDim2.new(0.8, 0, 0, 35)
NameToggle.Position = UDim2.new(0.1, 0, 0, 105)
NameToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
NameToggle.Text = "显示名字: 关闭"
NameToggle.TextColor3 = Color3.new(1, 1, 1)
NameToggle.TextSize = 14
NameToggle.Parent = ESPFrame

-- 3D框开关
local BoxToggle = Instance.new("TextButton")
BoxToggle.Name = "BoxToggle"
BoxToggle.Size = UDim2.new(0.8, 0, 0, 35)
BoxToggle.Position = UDim2.new(0.1, 0, 0, 150)
BoxToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
BoxToggle.Text = "3D框: 关闭"
BoxToggle.TextColor3 = Color3.new(1, 1, 1)
BoxToggle.TextSize = 14
BoxToggle.Parent = ESPFrame

-- 透视状态显示
local ESPStatus = Instance.new("TextLabel")
ESPStatus.Name = "ESPStatus"
ESPStatus.Size = UDim2.new(1, 0, 0, 50)
ESPStatus.Position = UDim2.new(0, 0, 0, 195)
ESPStatus.BackgroundTransparency = 1
ESPStatus.Text = "透视功能准备就绪"
ESPStatus.TextColor3 = Color3.new(1, 1, 1)
ESPStatus.TextSize = 14
ESPStatus.TextWrapped = true
ESPStatus.Parent = ESPFrame

-- 标签页切换逻辑
Tab1Btn.MouseButton1Click:Connect(function()
    NoticeLabel.Visible = true
    EatWorldScrollFrame.Visible = false
    ESPScrollFrame.Visible = false
    Tab1Btn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
    Tab2Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
    Tab3Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
end)

Tab2Btn.MouseButton1Click:Connect(function()
    NoticeLabel.Visible = false
    EatWorldScrollFrame.Visible = true
    ESPScrollFrame.Visible = false
    Tab1Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
    Tab2Btn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
    Tab3Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
end)

Tab3Btn.MouseButton1Click:Connect(function()
    NoticeLabel.Visible = false
    EatWorldScrollFrame.Visible = false
    ESPScrollFrame.Visible = true
    Tab1Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
    Tab2Btn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
    Tab3Btn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
end)

-- 关闭按钮功能
CloseBtn.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- 最小化按钮功能
local isMinimized = false
MinimizeBtn.MouseButton1Click:Connect(function()
    if isMinimized then
        -- 恢复窗口
        MainFrame.Size = UDim2.new(0, 500, 0, 400)
        MinimizeBtn.Text = "_"
        isMinimized = false
    else
        -- 最小化窗口
        MainFrame.Size = UDim2.new(0, 500, 0, 30)
        MinimizeBtn.Text = "□"
        isMinimized = true
    end
end)

-- 飞行功能
local flying = false
FlyBtn.MouseButton1Click:Connect(function()
    if not flying then
        -- 执行飞行脚本
        loadstring("\108\111\97\100\115\116\114\105\110\103\40\103\97\109\101\58\72\116\116\112\71\101\116\40\40\39\104\116\116\112\115\58\47\47\103\105\115\116\46\103\105\116\104\117\98\117\115\101\114\99\111\110\116\101\110\116\46\99\111\109\47\109\101\111\122\111\110\101\89\84\47\98\102\48\51\55\100\102\102\57\102\48\97\55\48\48\49\55\51\48\52\100\100\100\54\55\102\100\99\100\51\55\48\47\114\97\119\47\101\49\52\101\55\52\102\52\50\53\98\48\54\48\100\102\53\50\51\51\52\51\99\102\51\48\98\55\56\55\48\55\52\101\98\51\99\53\100\50\47\97\114\99\101\117\115\37\50\53\50\48\120\37\50\53\50\48\102\108\121\37\50\53\50\48\50\37\50\53\50\48\111\98\102\108\117\99\97\116\111\114\39\41\44\116\114\117\101\41\41\40\41\10\10")()
        FlyStatus.Text = "飞行功能已激活"
        FlyBtn.Text = "关闭飞行"
        flying = true
    else-- 这里可以添加关闭飞行的代码
        FlyStatus.Text = "飞行功能未激活"
        FlyBtn.Text = "飞行功能"
        flying = false
    end
end)

-- ========== 无敌模式功能 ==========
local godModeEnabled = false
local originalWalkSpeed = 16
local originalJumpHeight = 50

GodModeBtn.MouseButton1Click:Connect(function()
    godModeEnabled = not godModeEnabled
    
    if godModeEnabled then
        -- 启用无敌模式
        GodModeBtn.BackgroundColor3 = Color3.new(0.2, 0.8, 0.2)
        GodModeBtn.Text = "无敌模式: 开启"
        GodModeStatus.Text = "无敌模式已激活 - 您现在是无敌状态！"
        GodModeStatus.TextColor3 = Color3.new(0, 1, 0)
        
        -- 保存原始速度设置
        local player = Players.LocalPlayer
        if player.Character then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            if humanoid then
                originalWalkSpeed = humanoid.WalkSpeed
                originalJumpHeight = humanoid.JumpHeight
            end
        end
        
        -- 应用无敌效果
        applyGodMode()
        
    else
        -- 关闭无敌模式
        GodModeBtn.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)
        GodModeBtn.Text = "无敌模式: 关闭"
        GodModeStatus.Text = "无敌模式未激活"
        GodModeStatus.TextColor3 = Color3.new(1, 1, 1)
        
        -- 恢复原始设置
        removeGodMode()
    end
end)

function applyGodMode()
    local player = Players.LocalPlayer
    
    -- 角色添加时应用无敌
    local function setupCharacter(character)
        if not character then return end
        
        -- 等待角色完全加载
        wait(2)
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then
            -- 如果找不到Humanoid，等待它出现
            StatusLabel.Text = "等待Humanoid加载..."
            StatusLabel.TextColor3 = Color3.new(1, 1, 0)
            
            local startTime = tick()
            repeat
                wait(0.1)
                humanoid = character:FindFirstChild("Humanoid")
            until humanoid or tick() > startTime + 5 -- 最多等待5秒
            
            if not humanoid then
                GodModeStatus.Text = "错误：无法找到Humanoid！"
                GodModeStatus.TextColor3 = Color3.new(1, 0, 0)
                warn("无法找到Humanoid，无敌模式应用失败")
                return
            end
        end
        
        -- 防止角色死亡
        humanoid.BreakJointsOnDeath = false
        
        -- 设置最大生命值并防止受伤
        humanoid.MaxHealth = math.huge
        humanoid.Health = math.huge
        
        -- 连接受伤事件以防止伤害
        humanoid.HealthChanged:Connect(function()
            if humanoid.Health < math.huge then
                humanoid.Health = math.huge
            end
        end)
        
        -- 防止从高处坠落死亡
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            -- 添加防摔保护
            local bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            bodyVelocity.MaxForce = Vector3.new(0, 0, 0)
            bodyVelocity.Parent = rootPart
        end
        
        GodModeStatus.Text = "无敌模式已激活 - 您现在是无敌状态！"
        GodModeStatus.TextColor3 = Color3.new(0, 1, 0)
        print("无敌模式已应用于角色")
    end
    
    -- 应用当前角色
    if player.Character then
        setupCharacter(player.Character)
    end
    
    -- 角色重生时重新应用
    player.CharacterAdded:Connect(setupCharacter)
end

function removeGodMode()
    local player = Players.LocalPlayer
    
    -- 恢复角色设置
    if player.Character then
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.MaxHealth = 100
            humanoid.Health = 100
            humanoid.BreakJointsOnDeath = true
            humanoid.WalkSpeed = originalWalkSpeed
            humanoid.JumpHeight = originalJumpHeight
        end
    end
end

-- ========== 新增血量回复功能 ==========
local healthRegenEnabled = false
local healthRegenConnection = nil
local regenSpeed = 5 -- 默认每秒回复5点血量

HealthRegenBtn.MouseButton1Click:Connect(function()
    healthRegenEnabled = not healthRegenEnabled
    
    if healthRegenEnabled then
        -- 启用血量回复
        HealthRegenBtn.BackgroundColor3 = Color3.new(0.2, 0.8, 0.2)
        HealthRegenBtn.Text = "血量回复: 开启"
        HealthRegenStatus.Text = "血量回复已激活 - 正在自动回复血量"
        HealthRegenStatus.TextColor3 = Color3.new(0, 1, 0)
        
        -- 获取回复速度
        local speedValue = tonumber(RegenSpeedTextBox.Text)
        if speedValue and speedValue > 0 then
            regenSpeed = speedValue
        else
            regenSpeed = 5 -- 默认值
            RegenSpeedTextBox.Text = "5"
        end
        
        -- 启动血量回复
        startHealthRegen()
        
    else
        -- 关闭血量回复
        HealthRegenBtn.BackgroundColor3 = Color3.new(0.8, 0.3, 0.3)
        HealthRegenBtn.Text = "血量回复: 关闭"
        HealthRegenStatus.Text = "血量回复未激活"
        HealthRegenStatus.TextColor3 = Color3.new(1, 1, 1)
        
        -- 停止血量回复
        stopHealthRegen()
    end
end)

function startHealthRegen()
    local player = Players.LocalPlayer
    
    -- 停止现有的回复循环
    stopHealthRegen()
    
    -- 创建新的回复循环
    healthRegenConnection = RunService.Heartbeat:Connect(function()
        if player.Character then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health > 0 and humanoid.Health < humanoid.MaxHealth then
                -- 缓慢回复血量
                local newHealth = math.min(humanoid.Health + (regenSpeed * 0.033), humanoid.MaxHealth)
                humanoid.Health = newHealth
                
                -- 更新状态显示当前血量
                HealthRegenStatus.Text = string.format("血量回复中: %.1f/%.1f (+%.1f/秒)", 
                    humanoid.Health, humanoid.MaxHealth, regenSpeed)
            elseif humanoid and humanoid.Health >= humanoid.MaxHealth then
                HealthRegenStatus.Text = string.format("血量已满: %.1f/%.1f", 
                    humanoid.Health, humanoid.MaxHealth)
            end
        end
    end)
    
    -- 角色重生时重新应用
    player.CharacterAdded:Connect(function(character)
        wait(1) -- 等待角色完全加载
        if healthRegenEnabled then
            HealthRegenStatus.Text = "血量回复已激活 - 正在自动回复血量"
        end
    end)
end

function stopHealthRegen()
    if healthRegenConnection then
        healthRegenConnection:Disconnect()
        healthRegenConnection = nil
    end
end

-- 应用设置功能（已修复）
ApplyBtn.MouseButton1Click:Connect(function()
    local player = Players.LocalPlayer
    
    -- 确保角色存在，如果不存在则等待
    if not player.Character then
        StatusLabel.Text = "等待角色生成..."
        StatusLabel.TextColor3 = Color3.new(1, 1, 0) -- 黄色
        
        -- 等待角色生成
        player.CharacterAdded:Wait()
        wait(1) -- 额外等待确保完全加载
    end
    
    local character = player.Character
    
    -- 确保Humanoid存在，如果不存在则等待
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then
        StatusLabel.Text = "等待Humanoid加载..."
        StatusLabel.TextColor3 = Color3.new(1, 1, 0) -- 黄色
        
        -- 等待Humanoid出现
        local startTime = tick()
        repeat
            wait(0.1)
            humanoid = character:FindFirstChild("Humanoid")
        until humanoid or tick() > startTime + 5 -- 最多等待5秒
        
        if not humanoid then
            StatusLabel.Text = "错误：找不到Humanoid！"
            StatusLabel.TextColor3 = Color3.new(1, 0, 0)
            wait(3)
            StatusLabel.Text = "等待设置..."
            StatusLabel.TextColor3 = Color3.new(1, 1, 1)
            return
        end
    end
    
    -- 获取输入的值
    local speedValue = tonumber(SpeedTextBox.Text)
    local jumpValue = tonumber(JumpTextBox.Text)
    
    if speedValue and jumpValue then
        -- 设置速度
        humanoid.WalkSpeed = speedValue
        
        -- 设置跳跃高度
        humanoid.JumpHeight = jumpValue
        
        -- 更新原始速度设置（用于无敌模式关闭时恢复）
        originalWalkSpeed = speedValue
        originalJumpHeight = jumpValue
        
        -- 显示成功消息
        StatusLabel.Text = "启用成功！速度:" .. speedValue .. " 跳跃:" .. jumpValue
        StatusLabel.TextColor3 = Color3.new(0, 1, 0) -- 绿色
        
        -- 3秒后恢复原状态
        wait(3)
        StatusLabel.Text = "等待设置..."
        StatusLabel.TextColor3 = Color3.new(1, 1, 1)
    else
        -- 显示错误消息
        StatusLabel.Text = "请输入有效的数字！"
        StatusLabel.TextColor3 = Color3.new(1, 0, 0) -- 红色
        
        -- 3秒后恢复原状态
        wait(3)
        StatusLabel.Text = "等待设置..."
        StatusLabel.TextColor3 = Color3.new(1, 1, 1)
    end
end)

-- ========== 透视功能实现 ==========
local rayEnabled = false
local nameEnabled = false
local boxEnabled = false
local espConnections = {}
local espObjects = {}

-- 创建3D框
function createBox(character)
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    -- 删除旧的ESP对象
    if espObjects[character] then
        for _, obj in pairs(espObjects[character]) do
            if obj then
                obj:Destroy()
            end
        end
    end
    
    espObjects[character] = {}
    
    -- 创建3D框
    if boxEnabled then
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "ESPBox"
        box.Adornee = character
        box.AlwaysOnTop = true
        box.ZIndex = 10
        box.Size = character:GetExtentsSize()
        box.Color3 = Color3.new(1, 0, 0) -- 红色
        box.Transparency = 0.7
        box.Parent = character
        table.insert(espObjects[character], box)
    end
    
    -- 创建名字标签
    if nameEnabled then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESPName"
        billboard.Adornee = character:FindFirstChild("Head")
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(1, 0, 1, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = character.Name
        nameLabel.TextColor3 = Color3.new(1, 1, 1)
        nameLabel.TextStrokeTransparency = 0
        nameLabel.TextSize = 14
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.Parent = billboard
        
        billboard.Parent = character
        table.insert(espObjects[character], billboard)
    end
    
    -- 创建射线
    if rayEnabled then
        local ray = Instance.new("BoxHandleAdornment")
        ray.Name = "ESPRay"
        ray.Adornee = character
        ray.AlwaysOnTop = true
        ray.ZIndex = 5
        ray.Size = Vector3.new(0.2, 0.2, 100)
        ray.Color3 = Color3.new(0, 1, 0) -- 绿色
        ray.Transparency = 0.5
        ray.Parent = character
        table.insert(espObjects[character], ray)
    end
end

-- 更新所有玩家的ESP
function updateESP()
    -- 清除所有ESP对象
    for character, objects in pairs(espObjects) do
        for _, obj in pairs(objects) do
            if obj then
                obj:Destroy()
            end
        end
    end
    espObjects = {}
    
    -- 为所有玩家创建ESP
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character then
            createBox(player.Character)
        end
    end
end

-- 玩家加入游戏时创建ESP
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        if rayEnabled or nameEnabled or boxEnabled then
            wait(1) -- 等待角色完全加载
            createBox(character)
        end
    end)
end)

-- 玩家离开游戏时清除ESP
Players.PlayerRemoving:Connect(function(player)
    if espObjects[player.Character] then
        for _, obj in pairs(espObjects[player.Character]) do
            if obj then
                obj:Destroy()
            end
        end
        espObjects[player.Character] = nil
    end
end)

-- 射线功能开关
RayToggle.MouseButton1Click:Connect(function()
    rayEnabled = not rayEnabled
    if rayEnabled then
        RayToggle.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
        RayToggle.Text = "射线功能: 开启"
        ESPStatus.Text = "射线功能已开启"
    else
        RayToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
        RayToggle.Text = "射线功能: 关闭"
        ESPStatus.Text = "射线功能已关闭"
    end
    updateESP()
end)

-- 显示名字开关
NameToggle.MouseButton1Click:Connect(function()
    nameEnabled = not nameEnabled
    if nameEnabled then
        NameToggle.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
        NameToggle.Text = "显示名字: 开启"
        ESPStatus.Text = "显示名字功能已开启"
    else
        NameToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
        NameToggle.Text = "显示名字: 关闭"
        ESPStatus.Text = "显示名字功能已关闭"
    end
    updateESP()
end)

-- 3D框开关
BoxToggle.MouseButton1Click:Connect(function()
    boxEnabled = not boxEnabled
    if boxEnabled then
        BoxToggle.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
        BoxToggle.Text = "3D框: 开启"
        ESPStatus.Text = "3D框功能已开启"
    else
        BoxToggle.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
        BoxToggle.Text = "3D框: 关闭"
        ESPStatus.Text = "3D框功能已关闭"
    end
    updateESP()
end)

-- UI拖动功能
local isDragging = false
local dragStartPos = Vector2.new()
local frameStartPos = UDim2.new()

TitleLabel.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = true
        dragStartPos = input.Position
        frameStartPos = MainFrame.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStartPos
        MainFrame.Position = UDim2.new(
            frameStartPos.X.Scale,
            frameStartPos.X.Offset + delta.X,
            frameStartPos.Y.Scale,
            frameStartPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)
